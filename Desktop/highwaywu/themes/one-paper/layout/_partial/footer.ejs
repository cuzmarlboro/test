<div class="footer">
    <span>Copyright © <%= config.title %></span>
</div>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0J08LEJQFT"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-0J08LEJQFT');
</script>

<script defer src="https://umami-teal-tau.vercel.app/script.js"
    data-website-id="beba2175-6fc4-435b-9e3d-07a7c6d06da6"></script>

<%- css('css/a11y-dark.min.css') %>
    <%- js('js/highlight.min.js') %>
        <%- js('js/highlightjs-line-numbers.js') %>

            <script>
                hljs.initHighlightingOnLoad();
                hljs.initLineNumbersOnLoad();

                // 添加页面监视器
                function setupContainerObserver() {
                    const observer = new MutationObserver((mutations, obs) => {
                        const currentPath = window.location.pathname;

                        // 检查 thoughts 页面
                        if (currentPath.includes('/thoughts/')) {
                            const thoughtsContainer = document.getElementById('thoughts-container');
                            if (!thoughtsContainer) {
                                console.log('Waiting for thoughts container...');
                                return;
                            }

                            if (!thoughtsContainer.children.length || thoughtsContainer.children.length === 0) {
                                console.log('Thoughts container empty, initializing...');
                                // 确保脚本和数据已加载
                                const loadScript = () => {
                                    if (window.loadThoughts && window.thoughtsData) {
                                        loadThoughts();
                                        if (window.initRandomButton) initRandomButton();
                                    } else {
                                        console.log('Waiting for thoughts scripts...');
                                        // 动态加载 thoughts.js
                                        const script = document.createElement('script');
                                        script.src = '../js/thoughts.js';
                                        script.onload = () => setTimeout(loadScript, 100);
                                        document.head.appendChild(script);
                                    }
                                }
                                loadScript();
                            }
                        }

                        // 检查 yinian 页面
                        if (currentPath.includes('/yinian2/')) {
                            const yinianContainer = document.getElementById('yinian-container');
                            if (!yinianContainer) {
                                console.log('Waiting for yinian container...');
                                return;
                            }

                            if (!yinianContainer.children.length || yinianContainer.children.length === 0) {
                                console.log('Yinian container empty, initializing...');
                                // 确保脚本和数据已加载
                                const loadScript = () => {
                                    if (window.loadYinian && window.yinianData) {
                                        loadYinian();
                                        if (window.initRandomButton) initRandomButton();
                                    } else {
                                        console.log('Waiting for yinian scripts...');
                                        // 动态加载 yinian.js
                                        const script = document.createElement('script');
                                        script.src = '../js/yinian.js';
                                        script.onload = () => setTimeout(loadScript, 100);
                                        document.head.appendChild(script);
                                    }
                                }
                                loadScript();
                            }
                        }
                    });

                    // 观察整个 document.body 的变化
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }

                // 检查是否已经初始化了pjax
                if (!window.pjax) {
                    window.pjax = new Pjax({
                        selectors: [
                            "title",
                            ".paper-main",
                            "#mobile-nav"
                        ],
                        cacheBust: false,
                        scrollTo: false
                    });

                    // 简化的事件处理
                    document.addEventListener('pjax:send', function () {
                        document.body.classList.add('is-loading');
                    });

                    document.addEventListener('pjax:complete', function () {
                        document.body.classList.remove('is-loading');
                        // 重新初始化页面脚本
                        setTimeout(() => {
                            // 根据页面类型加载相应的脚本
                            const currentPath = window.location.pathname;
                            if (currentPath.includes('/thoughts/')) {
                                const script = document.createElement('script');
                                script.src = '../js/thoughts.js';
                                document.head.appendChild(script);
                            }
                            if (currentPath.includes('/yinian2/')) {
                                const script = document.createElement('script');
                                script.src = '../js/yinian.js';
                                document.head.appendChild(script);
                            }

                            setupContainerObserver();
                            // 检查当前页面类型
                            let currentPath = window.location.pathname;

                            if (currentPath.includes('/thoughts/') && window.loadThoughts && window.thoughtsData) {
                                // 确保容器存在
                                const container = document.getElementById('thoughts-container');
                                if (!container) {
                                    console.warn('Container not found, retrying...');
                                    setTimeout(() => {
                                        if (window.loadThoughts && window.thoughtsData) {
                                            loadThoughts();
                                            initRandomButton();
                                        }
                                    }, 500);
                                    return;
                                }

                                // 确保函数和数据都存在
                                if (window.loadThoughts && window.thoughtsData) {
                                    loadThoughts();
                                    initRandomButton();
                                }
                            }

                            if (currentPath.includes('/yinian2/')) {
                                // 确保容器存在
                                const container = document.getElementById('yinian-container');
                                if (!container) {
                                    console.warn('Container not found, retrying...');
                                    setTimeout(() => {
                                        if (window.loadYinian && window.yinianData) {
                                            loadYinian();
                                            initRandomButton();
                                        }
                                    }, 500);
                                    return;
                                }

                                // 确保函数和数据都存在
                                if (window.loadYinian && window.yinianData) {
                                    loadYinian();
                                    initRandomButton();
                                }
                            }
                        }, 200);
                    });
                }

                // 初始化观察器
                document.addEventListener('DOMContentLoaded', setupContainerObserver);
            </script>